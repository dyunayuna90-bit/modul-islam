<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Modul Islamisasi di Sumatra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Memuat React dan ReactDOM dari CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Memuat Babel Standalone untuk kompilasi JSX di browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      body {
        font-family: 'Manrope', sans-serif;
        background-color: #f9fafb;
        scrollbar-width: thin;
        scrollbar-color: #065f46 #f3f4f6;
      }
      body::-webkit-scrollbar {
        width: 8px;
      }
      body::-webkit-scrollbar-track {
        background: #f3f4f6;
      }
      body::-webkit-scrollbar-thumb {
        background-color: #065f46;
        border-radius: 10px;
        border: 2px solid #f3f4f6;
      }
      .font-manrope { font-family: 'Manrope', sans-serif; }
      .perspective-1000 { perspective: 1000px; }
      .transform-style-preserve-3d { transform-style: preserve-3d; }
      .backface-hidden { backface-visibility: hidden; }
      .timeline-desc {
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.3;
      }
      .fluid-popup-transition {
        transition: width 300ms cubic-bezier(0.4, 0, 0.2, 1), 
                    height 300ms cubic-bezier(0.4, 0, 0.2, 1), 
                    top 300ms cubic-bezier(0.4, 0, 0.2, 1), 
                    left 300ms cubic-bezier(0.4, 0, 0.2, 1),
                    opacity 300ms cubic-bezier(0.4, 0, 0.2, 1);
      }
      .fluid-popup-content-enter { opacity: 0; }
      .fluid-popup-content-enter-active { opacity: 1; transition: opacity 200ms ease-in 150ms; }
      .fluid-popup-content-exit { opacity: 1; }
      .fluid-popup-content-exit-active { opacity: 0; transition: opacity 150ms ease-out; }
      .tooltip-caret::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: white transparent transparent transparent;
      }
      img.materi {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 8px;
      }
    </style>
</head>
<body class="text-black antialiased">
    <div id="root"></div>
    <script type="text/babel">
// De-struktur hook React dari objek global React
const { useState, useEffect, useCallback, createContext, useContext, useRef, useMemo } = React;

// --- TIPE DATA (Interface dihapus oleh Babel, disimpan di sini untuk kejelasan) ---
/*
interface GameState { ... }
... (semua interface lain)
*/

// --- KONSTANTA ---
const XP_PER_LEVEL = 100;
const LEVELS = ['Musafir', 'Santri', 'Ulama', 'Wali', 'Sultan', 'Sejarawan Agung'];

const QUIZ_BAB_1 = {
  id: 'quiz-bab-1',
  title: "Uji Pengetahuan: Samudra Pasai",
  questions: [
    { question: "Siapakah pendiri Kesultanan Samudra Pasai yang juga dikenal dengan nama Meurah Silu?", options: ["Sultan Iskandar Muda", "Sultan Malik as-Saleh", "Sultan Alaudin Riayat Syah", "Sultan Zainal Abidin"], correctAnswer: 1, xp: 20 },
    { question: "Apa peran utama Samudra Pasai dalam sejarah Islam di Nusantara?", options: ["Menjadi pusat militer terbesar", "Menjadi pusat perdagangan rempah pertama", "Menjadi pusat studi Islam dan titik awal penyebaran Islam", "Menjadi kerajaan agraris"], correctAnswer: 2, xp: 25 },
    { question: "Pelancong terkenal dari Maroko yang mengunjungi Samudra Pasai dan mencatat kemajuannya adalah...", options: ["Marco Polo", "Vasco da Gama", "Ibnu Batutah", "Ferdinand Magellan"], correctAnswer: 2, xp: 20 },
  ]
};

const MATCHING_QUIZ_BAB_2 = {
  id: 'matching-bab-2',
  title: "Pasangkan Tokoh dan Konsep Aceh",
  instructions: "Cocokkan tokoh atau konsep dari Kesultanan Aceh Darussalam dengan deskripsi yang tepat.",
  pairs: [
    { id: 1, cause: "Sultan Iskandar Muda", effect: "Membawa Aceh ke puncak kejayaan maritim dan teritorial." },
    { id: 2, cause: "Kanun Meukuta Alam", effect: "Kitab undang-undang hukum yang mengatur tata pemerintahan Kesultanan Aceh." },
    { id: 3, cause: "Perdagangan Lada", effect: "Komoditas utama yang menjadikan Aceh sebagai bandar perdagangan internasional yang kaya." },
    { id: 4, cause: "Armada Laut yang Kuat", effect: "Alat utama untuk mengontrol Selat Malaka dan bersaing dengan Portugis." },
  ],
  xp: 50
};

const TIMELINE_BAB_3 = [
    { year: 'Abad ke-7', title: 'Awal Kejayaan Sriwijaya', description: 'Sriwijaya muncul sebagai kekuatan maritim dominan di Asia Tenggara, menguasai jalur perdagangan penting.', longDescription: 'Pada periode ini, Sriwijaya, dengan pusatnya di sekitar Palembang, berhasil menguasai Selat Malaka dan Selat Sunda. Kekuasaannya didasarkan pada kekuatan armada laut yang besar dan jaringan perdagangan yang luas, menjadikannya pusat penting bagi ajaran Buddha Mahayana.' },
    { year: '1025', title: 'Serangan Rajendra Chola', description: 'Kerajaan Chola dari India Selatan menyerang pusat-pusat kekuatan Sriwijaya.', longDescription: 'Serangan ini merupakan pukulan telak bagi Sriwijaya. Meskipun tidak menghancurkan kerajaan secara total, serangan ini melemahkan kontrol maritim Sriwijaya secara signifikan dan membuka jalan bagi kekuatan-kekuatan regional lain untuk bangkit.' },
    { year: 'Abad ke-11', title: 'Munculnya Pelabuhan Alternatif', description: 'Pelabuhan-pelabuhan di pesisir utara Sumatra mulai berkembang, mengurangi ketergantungan pada Sriwijaya.', longDescription: 'Seiring melemahnya Sriwijaya, para pedagang, terutama dari Arab dan Persia, mulai mencari pelabuhan alternatif yang lebih aman dan menguntungkan. Inilah cikal bakal munculnya kota-kota pelabuhan yang kemudian menjadi pusat penyebaran Islam.' },
    { year: 'Abad ke-13', title: 'Islamisasi Dimulai', description: 'Komunitas Muslim pertama mulai terbentuk di kota-kota pelabuhan seperti Perlak dan Samudra Pasai.', longDescription: 'Kontak intensif dengan para pedagang Muslim menyebabkan banyak penguasa lokal dan penduduk di pesisir memeluk Islam. Proses ini terjadi secara damai melalui perdagangan dan perkawinan, bukan penaklukan.' },
    { year: '1292', title: 'Laporan Marco Polo', description: 'Marco Polo mencatat keberadaan kerajaan Islam (Perlak) di Sumatra dalam perjalanan pulangnya.', longDescription: 'Catatan Marco Polo menjadi salah satu bukti tertulis dari Barat yang mengkonfirmasi eksistensi kerajaan Islam di Nusantara pada akhir abad ke-13, menandai pergeseran kekuatan politik dan agama di wilayah tersebut.' },
];

const INTERACTIVE_STRUCTURE_BAB_4 = {
    title: 'Harmoni Adat dan Islam di Minangkabau',
    items: [
        { id: '1', title: 'Adat Basandi Syarak', icon: 'âš–ï¸', description: 'Prinsip "Adat bersendi pada syariat" ini menjadi dasar filosofi hidup. Adat Minang yang sudah ada sebelumnya diselaraskan dengan ajaran Islam, di mana aturan adat tidak boleh bertentangan dengan Al-Qur\'an dan Hadis.', imgSrc: 'adat-syarak.jpg' },
        { id: '2', title: 'Syarak Basandi Kitabullah', icon: 'ðŸ“–', description: 'Prinsip kelanjutannya, "Syariat bersendi pada Kitabullah (Al-Qur\'an)". Ini memperkuat bahwa hukum Islam adalah sumber utama, yang kemudian menjadi rujukan bagi pelaksanaan adat. Keduanya saling melengkapi, bukan bertentangan.', imgSrc: 'kitabullah.jpg' },
        { id: '3', title: 'Sistem Matrilineal', icon: 'ðŸ‘©â€ðŸ‘§â€ðŸ‘¦', description: 'Islam tidak menghapus sistem matrilineal (garis keturunan dari pihak ibu) yang unik di Minangkabau. Harta pusaka tinggi tetap diwariskan melalui garis perempuan, sementara hukum waris Islam (faraidh) diterapkan pada harta pencaharian pribadi.', imgSrc: 'matrilineal.jpg' },
        { id: '4', title: 'Peran Tungku Tigo Sajarangan', icon: 'ðŸ›ï¸', description: 'Kepemimpinan komunal dipegang oleh tiga pilar: Ninik Mamak (pemimpin adat), Alim Ulama (pemimpin agama), dan Cerdik Pandai (kaum intelektual). Mereka bekerja sama dalam harmoni untuk mengatur kehidupan masyarakat.', imgSrc: 'tigo-sajarangan.jpg' },
        { id: '5', title: 'Rumah Gadang dan Surau', icon: 'ðŸ•Œ', description: 'Rumah Gadang tetap menjadi pusat kehidupan keluarga besar secara adat, sementara Surau (masjid/mushala) menjadi pusat kegiatan keagamaan, pendidikan Islam, dan sosial bagi kaum laki-laki, menunjukkan adanya pembagian ruang peran yang jelas.', imgSrc: 'surau.jpg' }
    ]
};

const LEGACY_EXPLORER_BAB_5 = {
    title: 'Jejak Akulturasi Islam di Sumatra',
    items: [
        { id: '1', name: 'Arsitektur Masjid', description: 'Banyak masjid kuno di Sumatra tidak memiliki kubah khas Timur Tengah. Sebaliknya, mereka mengadopsi atap tumpang (bertingkat) yang merupakan adaptasi dari arsitektur candi Hindu-Buddha atau rumah adat lokal, seperti pada Masjid Agung Demak di Jawa atau masjid-masjid kuno di Minangkabau.', imgSrc: 'arsitektur-masjid.jpg' },
        { id: '2', name: 'Sastra dan Aksara', description: 'Munculnya aksara Jawi (Arab-Melayu), yaitu huruf Arab yang dimodifikasi untuk menuliskan bahasa Melayu. Ini melahirkan karya-karya sastra besar seperti Hikayat Raja-Raja Pasai, yang memadukan narasi sejarah lokal dengan nilai-nilai Islam.', imgSrc: 'sastra-jawi.jpg' },
        { id: '3', name: 'Upacara Adat', description: 'Banyak upacara adat lokal yang dipertahankan namun diisi dengan nilai-nilai Islam. Contohnya adalah upacara Tabuik di Pariaman, yang berakar dari tradisi Syiah untuk memperingati Asyura, namun telah berakulturasi menjadi festival budaya lokal yang meriah.', imgSrc: 'upacara-tabuik.jpg' },
        { id: '4', name: 'Seni Kaligrafi', description: 'Seni kaligrafi Islam tidak hanya ditemukan di dalam masjid, tetapi juga diadaptasi ke media lain seperti ukiran kayu pada rumah adat, kain tenun, dan bahkan pada senjata tradisional, menunjukkan Islam telah meresap ke dalam sendi-sendi estetika lokal.', imgSrc: 'seni-kaligrafi.jpg' }
    ]
};

const CHAPTERS = [
  {
    id: 1,
    title: "Kesultanan Samudra Pasai",
    summary: "Mengenal kerajaan Islam pertama di Nusantara dan perannya sebagai pusat peradaban dan penyebaran Islam.",
    requiredXp: 0,
    xpReward: 30,
    content: [
        { type: 'heading', text: "Gerbang Islam di Nusantara" },
        { type: 'image', src: 'samudra-pasai.jpg', alt: 'Ilustrasi kejayaan Kesultanan Samudra Pasai dengan kapal-kapal dagang di pelabuhan.' },
        { type: 'subheading', text: "Sejarah Berdirinya Kerajaan" },
        { type: 'paragraph', text: "Kesultanan Samudra Pasai, yang terletak di pesisir utara Sumatra (kini Lhokseumawe, Aceh), diyakini sebagai kerajaan Islam pertama di Nusantara. Kerajaan ini didirikan pada abad ke-13 oleh Meurah Silu, yang setelah memeluk Islam bergelar Sultan Malik as-Saleh. Berita dari Marco Polo (1292) dan Ibnu Batutah (1345) mengkonfirmasi eksistensi dan kemajuan kerajaan ini. Lokasinya yang strategis di Selat Malaka menjadikannya bandar perdagangan penting yang menghubungkan para pedagang dari Arab, Persia, India, dan Tiongkok." },
        { type: 'subheading', text: "Pusat Studi Islam dan Intelektual" },
        { type: 'paragraph', text: "Samudra Pasai tidak hanya kaya karena perdagangan, tetapi juga menjadi pusat studi Islam yang terkemuka di Asia Tenggara. Sultan sangat mendukung perkembangan ilmu pengetahuan dan mengundang ulama-ulama dari berbagai negara. Ibnu Batutah mencatat bahwa Sultan adalah seorang yang sangat saleh, rendah hati, dan gemar berdiskusi tentang ilmu agama dengan para ulama. Dari sinilah ajaran Islam, terutama mazhab Syafi'i, menyebar ke berbagai wilayah lain di Nusantara melalui jalur perdagangan dan dakwah." },
        { type: 'quiz', data: QUIZ_BAB_1 },
    ]
  },
  {
    id: 2,
    title: "Kesultanan Aceh Darussalam",
    summary: "Menyelami masa kejayaan Kesultanan Aceh sebagai raksasa maritim, politik, dan ekonomi di Asia Tenggara.",
    requiredXp: 30,
    xpReward: 35,
    content: [
        { type: 'heading', text: "Sang Penerus Kejayaan Islam" },
        { type: 'image', src: 'kesultanan-aceh.jpg', alt: 'Ilustrasi kemegahan Masjid Raya Baiturrahman pada masa Kesultanan Aceh.' },
        { type: 'subheading', text: "Pewaris Kekuatan di Ujung Sumatra" },
        { type: 'paragraph', text: "Setelah kemunduran Samudra Pasai akibat ekspansi Portugis, Kesultanan Aceh Darussalam bangkit sebagai kekuatan baru. Didirikan pada akhir abad ke-15, Aceh mencapai puncak kejayaannya pada masa pemerintahan Sultan Iskandar Muda (1607-1636). Di bawah kepemimpinannya, Aceh menguasai seluruh pesisir barat dan timur Sumatra, serta sebagian Semenanjung Malaya. Kekuatan militernya, terutama armada lautnya yang besar, menjadi penantang utama dominasi Portugis di Selat Malaka." },
        { type: 'subheading', text: "Sistem Politik dan Ekonomi yang Maju" },
        { type: 'paragraph', text: "Aceh memiliki sistem pemerintahan yang teratur dan kuat, yang dituangkan dalam kitab hukum bernama 'Adat Meukuta Alam'. Perekonomiannya bertumpu pada perdagangan lada, yang menjadi komoditas paling dicari di pasar internasional saat itu. Aceh menjadi bandar transit yang ramai, menerapkan sistem pajak yang terorganisir dan menjalin hubungan diplomatik dengan kekuatan besar dunia, termasuk Kesultanan Utsmaniyah di Turki, Inggris, dan Belanda." },
        { type: 'matchingQuiz', data: MATCHING_QUIZ_BAB_2 },
    ]
  },
  {
    id: 3,
    title: "Runtuhnya Sriwijaya dan Transisi ke Islam",
    summary: "Memahami proses pergeseran kekuatan dari Kerajaan Buddha Sriwijaya ke era kesultanan Islam di Sumatra.",
    requiredXp: 65,
    xpReward: 30,
    content: [
        { type: 'heading', text: "Pergantian Babak Sejarah Sumatra" },
        { type: 'image', src: 'transisi-sriwijaya.jpg', alt: 'Ilustrasi kontras antara candi Sriwijaya yang mulai pudar dengan masjid yang mulai dibangun di pesisir.' },
        { type: 'subheading', text: "Faktor-Faktor Keruntuhan Sriwijaya" },
        { type: 'paragraph', text: "Kerajaan Sriwijaya, yang pernah menjadi penguasa lautan selama berabad-abad, mulai mengalami kemunduran sejak abad ke-11. Beberapa faktor utamanya adalah serangan militer dari Kerajaan Chola (India) pada tahun 1025 yang melemahkan armada lautnya, munculnya kekuatan pesaing seperti Singasari dan Majapahit di Jawa, serta perubahan jalur perdagangan internasional. Para pedagang mulai menghindari pusat kekuasaan Sriwijaya dan beralih ke pelabuhan-pelabuhan baru yang lebih kecil dan independen di pesisir utara Sumatra." },
        { type: 'subheading', text: "Transisi Damai Melalui Perdagangan" },
        { type: 'paragraph', text: "Proses Islamisasi di Sumatra tidak terjadi melalui penaklukan besar-besaran terhadap sisa-sisa Sriwijaya. Sebaliknya, ia berlangsung secara bertahap dan damai di pelabuhan-pelabuhan yang baru tumbuh. Para pedagang Muslim dari Arab, Persia, dan Gujarat membawa serta ajaran Islam. Mereka menikah dengan penduduk lokal dan membentuk komunitas-komunitas Muslim pertama. Para penguasa pelabuhan (datuk) melihat keuntungan dalam memeluk Islam, karena hal itu memperkuat hubungan dagang mereka dengan jaringan pedagang Muslim yang luas. Secara perlahan, pusat-pusat kekuatan baru yang bercorak Islam ini menggantikan pengaruh Sriwijaya yang semakin memudar." },
        { type: 'timeline', data: TIMELINE_BAB_3 },
    ]
  },
  {
    id: 4,
    title: "Islam di Minangkabau",
    summary: "Menjelajahi bagaimana Islam berakulturasi secara unik dengan adat dan sistem matrilineal masyarakat Minangkabau.",
    requiredXp: 95,
    xpReward: 30,
    content: [
        { type: 'heading', text: "Harmoni Antara Adat dan Agama" },
        { type: 'image', src: 'islam-minang.jpg', alt: 'Ilustrasi Rumah Gadang yang ikonik dengan latar belakang surau atau masjid, simbol harmoni.' },
        { type: 'subheading', text: "Peran Pedagang dan Ulama Sufi" },
        { type: 'paragraph', text: "Masuknya Islam ke wilayah dataran tinggi Minangkabau (darek) terjadi lebih lambat dibandingkan daerah pesisir (pasisia). Proses ini dipelopori oleh para pedagang yang datang dari Aceh dan Malaka, serta para ulama sufi seperti Syeikh Burhanuddin Ulakan. Mereka menyebarkan Islam dengan pendekatan yang bijaksana, tidak menentang adat istiadat yang telah mengakar kuat, melainkan mencari titik temu dan keselarasan." },
        { type: 'subheading', text: "Akulturasi Unik: Adat Basandi Syarak" },
        { type: 'paragraph', text: "Keunikan Islamisasi di Minangkabau terletak pada kemampuannya berdialog dengan adat lokal. Hasilnya adalah sebuah filosofi hidup yang terkenal: 'Adat basandi syarak, syarak basandi Kitabullah' (Adat bersendi pada syariat, syariat bersendi pada Al-Qur'an). Artinya, adat istiadat Minangkabau harus selaras dan tidak bertentangan dengan ajaran Islam. Sistem matrilineal, di mana garis keturunan dan warisan pusaka jatuh dari pihak ibu, tetap dipertahankan dan dianggap tidak bertentangan dengan prinsip-prinsip Islam, menciptakan sebuah sintesis budaya yang harmonis dan unik di Nusantara." },
        { type: 'interactiveStructure', data: INTERACTIVE_STRUCTURE_BAB_4 },
    ]
  },
   {
    id: 5,
    title: "Multikulturalisme dalam Islamisasi",
    summary: "Melihat bagaimana proses Islamisasi di Sumatra menciptakan budaya yang beragam dan penuh toleransi.",
    requiredXp: 125,
    xpReward: 35,
    content: [
        { type: 'heading', text: "Wajah Islam yang Beragam" },
        { type: 'image', src: 'akulturasi-budaya.jpg', alt: 'Kolase yang menunjukkan keberagaman budaya Islam di Sumatra: arsitektur, pakaian adat, dan seni.' },
        { type: 'subheading', text: "Bukan Penyeragaman, Tapi Penyerapan" },
        { type: 'paragraph', text: "Islamisasi di Sumatra dan Nusantara pada umumnya bukanlah proses penyeragaman budaya yang menghapus tradisi lokal. Sebaliknya, Islam datang dan diserap secara kreatif ke dalam kerangka budaya yang sudah ada. Islam memberikan warna dan nilai-nilai baru, sementara budaya lokal memberikan bentuk dan ekspresinya. Hal ini menghasilkan wajah Islam yang multikultural, di mana ekspresi keislaman di Aceh berbeda dengan di Minangkabau atau Palembang, meskipun akidahnya tetap sama." },
        { type: 'subheading', text: "Toleransi dan Harmoni" },
        { type: 'paragraph', text: "Proses yang sebagian besar berjalan damai ini mengajarkan tentang pentingnya toleransi. Para penyebar Islam awal tidak memaksakan budaya Arab, melainkan menggunakan medium lokal seperti seni, sastra, dan tradisi lisan untuk menyampaikan ajaran. Hasilnya adalah sebuah peradaban yang kaya, di mana berbagai etnis dan budaya dapat hidup berdampingan di bawah naungan nilai-nilai Islam yang universal, sambil tetap mempertahankan identitas lokal mereka. Inilah warisan terbesar dari sejarah Islamisasi di Sumatra." },
        { type: 'legacyExplorer', data: LEGACY_EXPLORER_BAB_5 },
    ]
  },
  {
    id: 6,
    title: "Ujian Akhir",
    summary: "Uji pemahaman akhir Anda tentang sejarah Islamisasi di Sumatra.",
    requiredXp: 160,
    xpReward: 0,
    content: [
        { type: 'heading', text: "Evaluasi Pemahaman Akhir" },
        { type: 'paragraph', text: "Selamat, Anda telah mencapai akhir dari perjalanan E-Modul ini! Anda telah menjelajahi jejak-jejak Islam di Sumatra, dari kesultanan pertama hingga akulturasi budaya yang kaya. Sekarang, saatnya untuk menguji semua pengetahuan yang telah Anda peroleh. Klik tombol di bawah ini untuk memulai ujian akhir. Semoga berhasil!" },
        { type: 'externalQuiz', text: "Mulai Ujian Akhir", url: "https://docs.google.com/forms/d/e/1FAIpQLScaJynnfQT7WnMqAsPnv0amx1At2Y3wlpjbfAHtOQvzftWY6g/viewform?usp=sf_link" }
    ]
  }
];

const BADGES = {
  CHAPTER_1_COMPLETE: { name: "Murid Pasai", description: "Menyelesaikan bab tentang Samudra Pasai.", condition: (gs) => gs.completedChapters.includes(1) },
  ALL_CHAPTERS_COMPLETE: { name: "Pakar Sejarah Sumatra", description: "Menyelesaikan semua bab materi.", condition: (gs) => gs.completedChapters.length >= 5 },
  LEVEL_3: { name: "Ulama Muda", description: "Mencapai Level 3.", condition: (gs) => gs.level >= 3 },
  QUIZ_MASTER: { name: "Ahli Kuis Kesultanan", description: "Menyelesaikan semua kuis di modul.", condition: (gs) => ['quiz-bab-1', 'matching-bab-2'].every(id => gs.quizStats[id]?.completed) }
};

const COMPREHENSIVE_CHATBOT_DATA = {
  general: [
    { id: 'g1', question: "Apa tema utama modul ini?", answer: "Modul ini membahas sejarah masuk dan berkembangnya Islam di Pulau Sumatra, mulai dari berdirinya kerajaan Islam pertama, masa kejayaan, hingga bagaimana Islam berakulturasi dengan budaya lokal yang sudah ada.",
      followUp: [
        { id: 'g1f1', question: "Apakah prosesnya lewat perang?", answer: "Sebagian besar proses Islamisasi di Sumatra terjadi secara damai melalui jalur perdagangan, pernikahan, dan dakwah oleh para ulama. Perang lebih sering terjadi antar kesultanan atau dengan bangsa Eropa." },
        { id: 'g1f2', question: "Apa kerajaan Islam pertama?", answer: "Kesultanan Samudra Pasai di Aceh diyakini sebagai kerajaan Islam pertama di Nusantara, berdiri sekitar abad ke-13." },
      ]
    },
    { id: 'g2', question: "Apa peninggalan utamanya?", answer: "Peninggalannya sangat beragam, mulai dari masjid-masjid dengan arsitektur unik, karya sastra tulisan Jawi (Arab-Melayu), hingga sistem hukum dan adat yang dipengaruhi nilai-nilai Islam." },
  ],
  1: [
    { id: 'c1q1', question: "Kenapa Samudra Pasai penting?", answer: "Sangat penting! Samudra Pasai adalah 'pintu gerbang' Islam di Nusantara. Dari pelabuhannya, ajaran Islam disebarkan oleh para pedagang dan ulama ke wilayah lain di Asia Tenggara.",
      followUp: [ { id: 'c1f1', question: "Siapa pendirinya?", answer: "Pendirinya adalah Meurah Silu, seorang penguasa lokal yang kemudian memeluk Islam dan bergelar Sultan Malik as-Saleh." } ]
    },
    { id: 'c1q2', question: "Apakah Pasai hanya pusat dagang?", answer: "Tidak hanya itu. Pasai juga merupakan pusat intelektual Islam yang maju. Banyak ulama dari Timur Tengah datang untuk mengajar, dan para santri dari berbagai daerah datang untuk belajar di sana." },
  ],
  2: [
    { id: 'c2q1', question: "Apa hubungan Aceh dengan Pasai?", answer: "Aceh bisa dibilang sebagai penerus dan pewaris kebesaran Pasai. Ketika Pasai melemah, Aceh bangkit menjadi kekuatan dominan baru di ujung utara Sumatra.",
      followUp: [
        { id: 'c2f1', question: "Siapa raja Aceh yang paling terkenal?", answer: "Sultan Iskandar Muda. Di masanya, Aceh mencapai puncak kejayaan, menguasai perdagangan lada dan memiliki armada laut yang ditakuti oleh Portugis." },
        { id: 'c2f2', question: "Apa itu 'Kanun Meukuta Alam'?", answer: "Itu adalah kitab undang-undang atau konstitusi Kesultanan Aceh yang mengatur segala aspek pemerintahan, dari hukum pidana hingga tata negara. Ini menunjukkan betapa teraturnya sistem pemerintahan Aceh saat itu." }
      ]
    },
  ],
  3: [
    { id: 'c3q1', question: "Kenapa Sriwijaya bisa runtuh?", answer: "Keruntuhannya kompleks. Faktor utamanya adalah serangan dari Kerajaan Chola (India) yang melemahkan militernya, serta munculnya pelabuhan-pelabuhan pesaing yang menggerogoti monopoli perdagangannya.",
      followUp: [ { id: 'c3f1', question: "Lalu bagaimana Islam masuk?", answer: "Islam masuk mengisi kekosongan yang ditinggalkan Sriwijaya. Para pedagang Muslim lebih memilih berlabuh di pelabuhan-pelabuhan baru yang lebih ramah. Di sanalah komunitas-komunitas Muslim pertama tumbuh dan berkembang menjadi kerajaan." } ]
    },
    { id: 'c3q2', question: "Jadi, tidak ada perang antara Sriwijaya dan Islam?", answer: "Tidak ada catatan perang besar antara sisa-sisa Sriwijaya melawan kesultanan Islam yang baru muncul. Transisinya lebih bersifat pergeseran ekonomi dan politik secara bertahap, bukan penaklukan militer." },
  ],
  4: [
      { id: 'c4q1', question: "Apa yang unik dari Islam di Minangkabau?", answer: "Keunikannya adalah perpaduan harmonis antara ajaran Islam dengan adat lokal yang sangat kuat, terutama sistem matrilineal (garis keturunan ibu)." },
      { id: 'c4q2', question: "Apa maksud 'Adat basandi syarak'?", answer: "Itu adalah filosofi mereka, artinya 'Adat bersendi pada syariat (hukum Islam)'. Ini menunjukkan bahwa adat Minang harus selaras dan tidak boleh bertentangan dengan ajaran Islam. Keduanya saling menguatkan." }
  ],
  5: [
      { id: 'c5q1', question: "Apa itu akulturasi?", answer: "Akulturasi adalah proses percampuran dua kebudayaan atau lebih yang saling bertemu dan saling memengaruhi, tanpa menghilangkan budaya asli. Contohnya, bentuk masjid yang atapnya seperti rumah adat, bukan kubah." },
      { id: 'c5q2', question: "Apakah Islam di Sumatra seragam?", answer: "Sama sekali tidak. Islam di Sumatra sangat beragam (multikultural). Cara orang Aceh mengekspresikan keislamannya berbeda dengan orang Minang atau Melayu, dan ini menunjukkan kekayaan budaya Islam di Nusantara." }
  ],
  6: [
      { id: 'c6q1', question: "Bagaimana cara saya mengerjakan ujian?", answer: "Sangat mudah! Cukup klik tombol 'Mulai Ujian Akhir' yang ada di halaman bab ini. Nanti Anda akan diarahkan ke halaman ujiannya di Google Forms." },
      { id: 'c6q2', question: "Apakah nilai ujian ini akan menambah XP?", answer: "Tidak. Ujian akhir ini murni untuk mengukur pemahaman Anda secara keseluruhan. XP hanya didapat dari menyelesaikan bab dan kuis di dalam modul ini." }
  ]
};

// --- HOOK: useGameState ---
const GameStateContext = createContext(undefined);

const defaultState = {
  playerName: "Penjelajah",
  xp: 0,
  level: 1,
  badges: [],
  completedChapters: [],
  quizStats: {},
};

const GameStateProvider = ({ children }) => {
  const [gameState, setGameState] = useState(() => {
    try {
      const savedState = localStorage.getItem('sumatraIslamGameState_v1');
      return savedState ? JSON.parse(savedState) : defaultState;
    } catch (error) {
      console.error("Tidak dapat memuat status permainan:", error);
      return defaultState;
    }
  });

  useEffect(() => {
    try {
      localStorage.setItem('sumatraIslamGameState_v1', JSON.stringify(gameState));
    } catch (error) {
      console.error("Tidak dapat menyimpan status permainan:", error);
    }
  }, [gameState]);
  
  const checkAndAwardBadges = (currentState) => {
      const newBadges = [...currentState.badges];
      Object.keys(BADGES).forEach(badgeKey => {
          if (!newBadges.includes(badgeKey) && BADGES[badgeKey].condition(currentState)) {
              newBadges.push(badgeKey);
          }
      });
      return newBadges;
  }

  const setPlayerName = (name) => {
    setGameState(prev => ({ ...prev, playerName: name }));
  };

  const addXp = useCallback((amount) => {
    setGameState(prev => {
      const newXp = prev.xp + amount;
      const clampedXp = Math.max(0, newXp);
      const newLevel = Math.floor(clampedXp / XP_PER_LEVEL) + 1;
      const newStateForCheck = { ...prev, xp: clampedXp, level: newLevel };
      const newBadges = checkAndAwardBadges(newStateForCheck);
      return { ...prev, xp: clampedXp, level: newLevel, badges: newBadges };
    });
  }, []);

  const completeChapter = useCallback((chapterId, xpReward) => {
    setGameState(prev => {
      if (prev.completedChapters.includes(chapterId)) return prev;
      const newXp = prev.xp + xpReward;
      const newLevel = Math.floor(newXp / XP_PER_LEVEL) + 1;
      const updatedChapters = [...prev.completedChapters, chapterId];
      const newStateForCheck = { ...prev, xp: newXp, level: newLevel, completedChapters: updatedChapters };
      const newBadges = checkAndAwardBadges(newStateForCheck);
      return { ...prev, xp: newXp, level: newLevel, completedChapters: updatedChapters, badges: newBadges };
    });
  }, []);
  
  const updateQuizStats = useCallback((quizId, stats) => {
    setGameState(prev => {
      const newStats = { ...prev.quizStats };
      const currentBest = newStats[quizId]?.bestScore || 0;
      const { score, ...restStats } = stats;
      newStats[quizId] = { ...newStats[quizId], ...restStats, bestScore: score !== undefined ? Math.max(currentBest, score) : currentBest };
      const newStateForCheck = { ...prev, quizStats: newStats };
      const newBadges = checkAndAwardBadges(newStateForCheck);
      return { ...prev, quizStats: newStats, badges: newBadges };
    });
  }, []);

  const value = { gameState, addXp, completeChapter, updateQuizStats, setPlayerName };
  return <GameStateContext.Provider value={value}>{children}</GameStateContext.Provider>;
};

const useGameState = () => {
  const context = useContext(GameStateContext);
  if (context === undefined) throw new Error('useGameState harus digunakan di dalam GameStateProvider');
  return context;
};

// --- KOMPONEN-KOMPONEN ---

const FluidPopup = ({ isOpen, onClose, triggerRef, children }) => {
  const [isMounted, setIsMounted] = useState(false);
  const [styles, setStyles] = useState({});
  const [contentClass, setContentClass] = useState('');
  useEffect(() => {
    if (isOpen) {
      setIsMounted(true);
      const rect = triggerRef.current?.getBoundingClientRect(); if (!rect) return;
      setStyles({ position: 'fixed', top: `${rect.top}px`, left: `${rect.left}px`, width: `${rect.width}px`, height: `${rect.height}px`, margin: 0, opacity: 0 });
      setContentClass('fluid-popup-content-enter');
      requestAnimationFrame(() => {
        setStyles({ position: 'fixed', top: '50%', left: '50%', width: 'auto', height: 'auto', transform: 'translate(-50%, -50%)', margin: 0, opacity: 1 });
        setContentClass('fluid-popup-content-enter fluid-popup-content-enter-active');
      });
    } else if (isMounted) {
      const rect = triggerRef.current?.getBoundingClientRect();
      if (!rect) { setIsMounted(false); return; };
      setContentClass('fluid-popup-content-exit fluid-popup-content-exit-active');
      setStyles(prev => ({ ...prev, top: `${rect.top}px`, left: `${rect.left}px`, width: `${rect.width}px`, height: `${rect.height}px`, transform: 'none', opacity: 0 }));
      setTimeout(() => setIsMounted(false), 300);
    }
  }, [isOpen, triggerRef, isMounted]);
  if (!isMounted) return null;
  return ReactDOM.createPortal(
    <>
      <div className={`fixed inset-0 bg-black/50 z-[100] transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose} aria-hidden="true"/>
      <div className="fixed z-[110] fluid-popup-transition flex items-center justify-center" style={styles} onClick={e => e.stopPropagation()} role="dialog" aria-modal="true">
        <div className={contentClass}>{children}</div>
      </div>
    </>, document.body
  );
};

const Chatbot = ({ currentChapterId, onClose }) => {
  const [messages, setMessages] = useState([]);
  const [currentQuestions, setCurrentQuestions] = useState([]);
  const [history, setHistory] = useState([]);
  const messagesEndRef = useRef(null);
  const mainQuestions = useMemo(() => currentChapterId && COMPREHENSIVE_CHATBOT_DATA[currentChapterId] ? COMPREHENSIVE_CHATBOT_DATA[currentChapterId] : COMPREHENSIVE_CHATBOT_DATA.general, [currentChapterId]);
  useEffect(() => { setMessages([{ sender: 'bot', text: "Salam! Saya Pustakawan Kuno. Pilih pertanyaan di bawah untuk memulai." }]); setCurrentQuestions(mainQuestions); setHistory([]); }, [mainQuestions]);
  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);
  const handleQuestionSelect = (questionNode) => {
    setMessages(prev => [...prev, { sender: 'user', text: questionNode.question }, { sender: 'bot', text: questionNode.answer }]);
    if (questionNode.followUp?.length > 0) { setHistory(prev => [...prev, currentQuestions]); setCurrentQuestions(questionNode.followUp); }
  };
  const handleBack = () => { const lastState = history[history.length - 1]; if(lastState) { setCurrentQuestions(lastState); setHistory(prev => prev.slice(0, -1)); } };
  return (
    <div className="bg-white rounded-2xl w-[22rem] h-[40rem] max-w-xs max-h-[80vh] flex flex-col shadow-2xl overflow-hidden">
      <header className="flex justify-between items-center p-4 bg-emerald-800 text-white flex-shrink-0">
        <h2 className="text-xl font-bold">Pustakawan Kuno</h2>
        <button onClick={onClose} className="text-3xl leading-none" aria-label="Tutup Chatbot">&times;</button>
      </header>
      <main className="flex-grow p-4 overflow-y-auto bg-gray-50">
        <div className="flex flex-col gap-4">
          {messages.map((msg, index) => ( <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] p-3 rounded-2xl ${msg.sender === 'user' ? 'bg-emerald-700 text-white rounded-br-none' : 'bg-white text-black rounded-bl-none border border-gray-200'}`}><p className="whitespace-pre-wrap">{msg.text}</p></div></div> ))}
          <div ref={messagesEndRef} />
        </div>
      </main>
      <footer className="p-4 border-t border-gray-200 bg-white flex-shrink-0 overflow-y-auto max-h-48">
        <div className="flex flex-col gap-2">
            {currentQuestions.map(q => ( <button key={q.id} onClick={() => handleQuestionSelect(q)} className="w-full text-left p-2.5 bg-gray-100 hover:bg-emerald-100 border border-gray-200 text-emerald-800 font-semibold rounded-lg text-sm transition-colors">{q.question}</button> ))}
            {history.length > 0 && ( <button onClick={handleBack} className="w-full text-center p-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg text-sm transition-colors mt-2">&larr; Kembali</button> )}
        </div>
      </footer>
    </div>
  );
};

const GLOSSARY_TERMS = { "Kesultanan": "Bentuk pemerintahan yang dikepalai oleh seorang Sultan; kerajaan Islam.", "Nusantara": "Istilah untuk menyebut wilayah kepulauan Asia Tenggara, khususnya Indonesia, Malaysia, dan sekitarnya.", "Mazhab Syafi'i": "Salah satu dari empat mazhab fikih (hukum Islam) dalam Islam Sunni yang paling banyak dianut di Asia Tenggara.", "Dakwah": "Kegiatan yang bersifat menyeru, mengajak dan memanggil orang untuk beriman dan taat kepada Allah sesuai dengan garis akidah, syari'at dan akhlak Islam.", "Akulturasi": "Proses percampuran dua kebudayaan atau lebih yang saling bertemu dan saling memengaruhi, tanpa menghilangkan budaya asli.", "Matrilineal": "Sistem kekerabatan yang menarik garis keturunan dari pihak ibu.", "Sufi": "Sebutan untuk orang yang mendalami sufisme atau tasawuf, yaitu ajaran untuk mengenal dan mendekatkan diri kepada Tuhan.", "Ulama": "Orang yang ahli dalam hal atau dalam pengetahuan agama Islam." };
const POPUP_WIDTH = 280; const SCREEN_PADDING = 16;
const GlossaryPopup = ({ text }) => {
  const [popup, setPopup] = useState(null); const spanRefs = useRef({});
  const handleMouseEnter = (term, key) => { const ref = spanRefs.current[key]; if (ref) { const rect = ref.getBoundingClientRect(); const scrollY = window.scrollY; let left = rect.left + rect.width / 2; const top = rect.top + scrollY - 10; const halfPopupWidth = POPUP_WIDTH / 2; if (left - halfPopupWidth < SCREEN_PADDING) left = SCREEN_PADDING + halfPopupWidth; else if (left + halfPopupWidth > window.innerWidth - SCREEN_PADDING) left = window.innerWidth - SCREEN_PADDING - halfPopupWidth; setPopup({ content: GLOSSARY_TERMS[term], top, left }); } };
  const handleMouseLeave = () => setPopup(null);
  const renderText = () => { const regex = new RegExp(`\\b(${Object.keys(GLOSSARY_TERMS).join('|')})\\b`, 'gi'); return text.split(regex).map((part, index) => { const normalizedPart = Object.keys(GLOSSARY_TERMS).find(k => k.toLowerCase() === part.toLowerCase()); if (normalizedPart) { const uniqueKey = `${normalizedPart}-${index}`; return <span key={uniqueKey} ref={el => spanRefs.current[uniqueKey] = el} onMouseEnter={() => handleMouseEnter(normalizedPart, uniqueKey)} onMouseLeave={handleMouseLeave} className="text-emerald-800 font-bold border-b-2 border-emerald-300 border-dashed cursor-pointer">{part}</span>; } return <span key={`text-${index}`}>{part}</span>; }); };
  return <p className="text-black text-sm leading-relaxed my-4 text-justify">{renderText()}{popup && ReactDOM.createPortal(<div className="absolute z-50 p-3 bg-white text-gray-800 text-sm rounded-lg shadow-xl max-w-xs transform -translate-x-1/2 -translate-y-full tooltip-caret" style={{ top: popup.top, left: popup.left, width: `${POPUP_WIDTH}px` }}>{popup.content}</div>, document.body)}</p>;
};

const Timeline = ({ data }) => {
  const [detailedEvent, setDetailedEvent] = useState(null);
  const sortedData = useMemo(() => [...data].sort((a, b) => parseInt(a.year) - parseInt(b.year)), [data]);
  return (
    <div className="my-12">
       <h3 className="text-2xl font-bold text-black mb-4 text-center">Linimasa Penting</h3>
       <div className="relative w-full border-l-2 border-emerald-200 pl-8 py-4">
            {sortedData.map((event, index) => (
                <div key={index} className="mb-8 relative">
                    <div className="absolute -left-[42px] top-1 w-5 h-5 bg-emerald-700 rounded-full border-4 border-white"></div>
                    <p className="text-sm font-semibold text-emerald-800">{event.year}</p>
                    <h4 className="text-lg font-bold text-black">{event.title}</h4>
                    <p className="text-sm text-gray-600 mt-1">{event.description}</p>
                    <button onClick={() => setDetailedEvent(event)} className="text-sm font-bold text-emerald-700 hover:underline mt-2">Baca Selengkapnya</button>
                </div>
            ))}
       </div>
       {detailedEvent && ReactDOM.createPortal(
         <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onClick={() => setDetailedEvent(null)}>
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-start"><div><p className="font-bold text-emerald-800">{detailedEvent.year}</p><h4 className="text-2xl font-bold text-black">{detailedEvent.title}</h4></div><button onClick={() => setDetailedEvent(null)} className="text-3xl text-gray-400 hover:text-gray-800 leading-none">&times;</button></div>
                <p className="mt-4 text-black leading-relaxed text-sm text-justify">{detailedEvent.longDescription}</p>
            </div>
         </div>, document.body )}
    </div>
  );
};

const LegacyExplorer = ({ data }) => {
  const [expandedId, setExpandedId] = useState(null);
  if (!data?.items?.length) return <div className="my-12 text-center text-gray-500">Konten tidak tersedia.</div>;
  const handleToggle = (id) => setExpandedId(prevId => (prevId === id ? null : id));
  return (
    <div className="my-12 p-4 bg-gray-50/50 rounded-lg border border-gray-200">
      <h3 className="text-2xl font-bold text-black mb-6 text-center">{data.title}</h3>
      <div className="space-y-3">
        {data.items.map((item) => (
          <div key={item.id} className="border-b border-gray-200 last:border-b-0">
            <button onClick={() => handleToggle(item.id)} className="w-full flex justify-between items-center text-left p-4 bg-white hover:bg-gray-50 transition-colors">
              <h4 className="text-lg font-bold text-emerald-800">{item.name}</h4>
              <span className={`transform transition-transform duration-300 ${expandedId === item.id ? 'rotate-180' : ''}`}><svg className="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg></span>
            </button>
            <div className={`grid transition-all duration-500 ease-in-out ${expandedId === item.id ? 'grid-rows-[1fr] opacity-100' : 'grid-rows-[0fr] opacity-0'}`}><div className="overflow-hidden"><div className="p-4 bg-white">
                {item.imgSrc && <img src={item.imgSrc} alt={item.name} className="w-full h-48 object-cover rounded-md mb-4 shadow-md" />}
                <p className="text-black leading-relaxed text-sm text-justify">{item.description}</p>
            </div></div></div>
          </div>
        ))}
      </div>
    </div>
  );
};

const InteractiveStructure = ({ data }) => {
    const [selectedItemId, setSelectedItemId] = useState(null);
    const handleItemClick = (itemId) => setSelectedItemId(currentItemId => currentItemId === itemId ? null : itemId);
    return (
        <div className="my-12 p-4 bg-gray-50/50 rounded-lg border border-gray-200">
            <h3 className="text-2xl font-bold text-black mb-6 text-center">{data.title}</h3>
            <div className="space-y-3">
                {data.items.map(item => (
                    <div key={item.id} className="bg-white rounded-lg shadow-sm overflow-hidden">
                        <button onClick={() => handleItemClick(item.id)} className="w-full flex items-center justify-between text-left p-4 hover:bg-gray-50 transition-colors">
                            <div className="flex items-center"><span className="text-3xl mr-4">{item.icon}</span><h4 className="text-lg font-semibold text-emerald-800">{item.title}</h4></div>
                            <span className={`transform transition-transform duration-300 ${selectedItemId === item.id ? 'rotate-180' : ''}`}><svg className="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg></span>
                        </button>
                        <div className={`grid transition-all duration-500 ease-in-out ${selectedItemId === item.id ? 'grid-rows-[1fr] opacity-100' : 'grid-rows-[0fr] opacity-0'}`}><div className="overflow-hidden"><div className="p-4 pt-0">
                            {item.imgSrc && <img src={item.imgSrc} alt={item.title} className="w-full h-48 object-cover rounded-md mb-4 shadow-md" />}
                            <p className="text-black text-sm leading-relaxed text-justify">{item.description}</p>
                        </div></div></div>
                    </div>
                ))}
            </div>
        </div>
    );
};

const Quiz = ({ data }) => {
  const { addXp, updateQuizStats, gameState } = useGameState();
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [score, setScore] = useState(0);
  const [isAnswered, setIsAnswered] = useState(false);
  const isFirstAttemptRef = useRef(!gameState.quizStats[data.id]?.hasOwnProperty('bestScore'));
  const questions = useMemo(() => [...data.questions].sort(() => 0.5 - Math.random()), [data.id]);
  if (!questions.length) return <div className="text-center p-4 bg-gray-100 rounded-lg">Kuis tidak tersedia.</div>;
  const currentQuestion = questions[currentQuestionIndex];
  const handleAnswerSubmit = () => { if (selectedAnswer === null) return; setIsAnswered(true); const isCorrect = selectedAnswer === currentQuestion.correctAnswer; if (isFirstAttemptRef.current && isCorrect) { const xp = currentQuestion.xp; addXp(xp); setScore(s => s + xp); } setTimeout(() => { if (currentQuestionIndex < questions.length - 1) { setCurrentQuestionIndex(i => i + 1); setSelectedAnswer(null); setIsAnswered(false); } else { if (isFirstAttemptRef.current) { const finalScore = isCorrect ? score + currentQuestion.xp : score; const totalPossibleXp = questions.reduce((acc, q) => acc + q.xp, 0); const percentage = totalPossibleXp > 0 ? (finalScore / totalPossibleXp) * 100 : 0; updateQuizStats(data.id, { score: Math.max(0, percentage), completed: true }); isFirstAttemptRef.current = false; setScore(finalScore); } setShowResult(true); } }, 1500); };
  const handleRestart = () => { setCurrentQuestionIndex(0); setSelectedAnswer(null); setShowResult(false); setScore(0); setIsAnswered(false); };
  const getButtonClass = (index) => { if (!isAnswered) return selectedAnswer === index ? 'bg-emerald-100 border-emerald-700' : 'bg-gray-100 hover:bg-gray-200 border-gray-200'; if (index === currentQuestion.correctAnswer) return 'bg-green-200 border-green-400 text-green-800'; if (index === selectedAnswer) return 'bg-red-200 border-red-400 text-red-800'; return 'bg-gray-100 opacity-60 border-gray-200'; };
  if (showResult) return <div className="my-8 p-6 bg-white border-2 border-emerald-800 rounded-xl text-center"><h3 className="text-2xl font-bold text-emerald-800">Hasil Kuis</h3><p className="text-lg text-black mt-4" dangerouslySetInnerHTML={{ __html: isFirstAttemptRef.current === false ? `Anda mendapatkan <span class="font-bold text-emerald-800">${score} XP</span> dalam upaya pertama Anda!` : "Kuis selesai. Anda bisa mencobanya lagi untuk latihan." }}></p><button onClick={handleRestart} className="mt-6 bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Coba Lagi</button></div>;
  return <div className="my-8 p-6 bg-white border-2 border-emerald-800 rounded-xl"><h3 className="text-2xl font-bold text-emerald-800 mb-4">{data.title}</h3><p className="text-black mb-4">{currentQuestion.question}</p><div className="flex flex-col gap-3">{currentQuestion.options.map((option, index) => <button key={index} onClick={() => setSelectedAnswer(index)} disabled={isAnswered} className={`w-full text-left p-3 rounded-lg transition-all duration-300 border ${getButtonClass(index)}`}>{option}</button>)}</div><button onClick={handleAnswerSubmit} disabled={selectedAnswer === null || isAnswered} className="mt-6 bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">Jawab</button></div>;
};

const MatchingQuiz = ({ data }) => {
    const { addXp, updateQuizStats, gameState } = useGameState();
    const [causes, setCauses] = useState([]); const [effects, setEffects] = useState([]); const [selectedCause, setSelectedCause] = useState(null); const [matches, setMatches] = useState({}); const [incorrectEffectId, setIncorrectEffectId] = useState(null);
    useEffect(() => { const shuffledEffects = [...data.pairs].sort(() => Math.random() - 0.5).map(p => ({ id: p.id, text: p.effect })); const staticCauses = data.pairs.map(p => ({ id: p.id, text: p.cause })); setCauses(staticCauses); setEffects(shuffledEffects); setMatches({}); }, [data]);
    const handleCauseClick = (cause) => { if (matches[cause.id]) return; setSelectedCause(cause); };
    const handleEffectClick = (effect) => { if (!selectedCause) return; if (selectedCause.id === effect.id) setMatches(prev => ({ ...prev, [selectedCause.id]: effect.id })); else { setIncorrectEffectId(effect.id); setTimeout(() => setIncorrectEffectId(null), 500); } setSelectedCause(null); };
    const isCompleted = Object.keys(matches).length === data.pairs.length; const isQuizDoneInState = gameState.quizStats[data.id]?.completed;
    useEffect(() => { if (isCompleted && !isQuizDoneInState) { addXp(data.xp); updateQuizStats(data.id, { completed: true, score: 100 }); } }, [isCompleted, isQuizDoneInState]);
    return <div className="my-8 p-6 bg-white border-2 border-emerald-800 rounded-xl"><div className="flex justify-between items-start mb-6"><div><h3 className="text-2xl font-bold text-emerald-800 mb-2">{data.title}</h3><p className="text-sm text-gray-600">{data.instructions}</p></div>{!isCompleted && (<div className="text-right flex-shrink-0 ml-4"><p className="text-xl font-bold text-emerald-800">{Object.keys(matches).length} / {data.pairs.length}</p><p className="text-sm text-gray-500">Pasangan Cocok</p></div>)}</div>{isCompleted ? (<div className="text-center p-4 bg-green-100 text-green-800 rounded-lg"><h4 className="font-bold">Luar Biasa!</h4><p>Anda telah berhasil mencocokkan semua, dan mendapatkan {data.xp} XP!</p></div>) : (<div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8"><div className="flex flex-col gap-3"><h4 className="font-bold text-center text-black mb-2">Tokoh / Konsep</h4>{causes.map(cause => (<button key={cause.id} onClick={() => handleCauseClick(cause)} disabled={!!matches[cause.id]} className={`p-3 rounded-lg text-sm text-left border transition-all duration-200 ${matches[cause.id] ? 'bg-green-100 border-green-300 text-gray-500 line-through cursor-not-allowed' : ''} ${selectedCause?.id === cause.id ? 'bg-emerald-100 border-emerald-700 ring-2 ring-emerald-400' : 'bg-gray-100 hover:bg-gray-200 border-gray-200'}`}>{cause.text}</button>))}</div><div className="flex flex-col gap-3"><h4 className="font-bold text-center text-black mb-2">Deskripsi</h4>{effects.map(effect => { const isMatched = Object.values(matches).includes(effect.id); const isIncorrect = incorrectEffectId === effect.id; let buttonClass = 'bg-gray-100 hover:bg-gray-200 border-gray-200'; if (isMatched) buttonClass = 'bg-green-100 border-green-300 text-gray-500 line-through cursor-not-allowed'; else if (isIncorrect) buttonClass = 'bg-red-200 border-red-500 animate-pulse'; return (<button key={effect.id} onClick={() => handleEffectClick(effect)} disabled={isMatched} className={`p-3 rounded-lg text-sm text-left border transition-all duration-200 ${buttonClass}`}>{effect.text}</button>); })}</div></div>)}</div>;
};

const ChapterView = ({ chapter, onClose }) => {
    const { completeChapter, gameState } = useGameState();
    const isCompleted = gameState.completedChapters.includes(chapter.id);
    const handleCompleteChapter = () => { if (!isCompleted) { completeChapter(chapter.id, chapter.xpReward); } onClose(); };
    const renderContentBlock = (block, index) => {
        switch (block.type) {
            case 'heading': return <h2 key={index} className="text-3xl md:text-4xl font-extrabold text-emerald-900 mt-10 mb-4">{block.text}</h2>;
            case 'subheading': return <h3 key={index} className="text-2xl font-bold text-black mt-8 mb-3">{block.text}</h3>;
            case 'paragraph': return <GlossaryPopup key={index} text={block.text} />;
            case 'image': return <img key={index} src={block.src} alt={block.alt} className="w-full h-[250px] object-cover rounded-lg my-6 shadow-md" />;
            case 'timeline': return <Timeline key={index} data={block.data} />;
            case 'quiz': return <Quiz key={index} data={block.data} />;
            case 'matchingQuiz': return <MatchingQuiz key={index} data={block.data} />;
            case 'legacyExplorer': return <LegacyExplorer key={index} data={block.data} />;
            case 'interactiveStructure': return <InteractiveStructure key={index} data={block.data} />;
            case 'externalQuiz': return (
                <div key={index} className="text-center my-12">
                     <a href={block.url} target="_blank" rel="noopener noreferrer" className="inline-block bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-4 px-10 text-lg rounded-lg transition-transform hover:scale-105 shadow-lg">{block.text}</a>
                </div>
            );
            default: return null;
        }
    };
    return (
        <div className="container mx-auto px-4 py-8">
            <button onClick={onClose} className="flex items-center gap-2 text-emerald-800 font-bold hover:underline mb-6"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Kembali ke Daftar Bab</button>
            <div className="bg-white p-6 sm:p-10 rounded-2xl shadow-lg">
                <span className="text-sm font-bold text-emerald-700 bg-emerald-100 py-1 px-3 rounded-full">BAB {chapter.id}</span>
                <h1 className="text-4xl md:text-5xl font-extrabold text-black mt-4">{chapter.title}</h1>
                <p className="text-lg text-gray-600 mt-2">{chapter.summary}</p>
                <hr className="my-8" />
                {chapter.content.map(renderContentBlock)}
                <div className="text-center mt-12"><button onClick={handleCompleteChapter} className="bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform hover:scale-105">{isCompleted ? 'Kembali ke Daftar Bab' : `Selesaikan Bab (+${chapter.xpReward} XP)`}</button></div>
            </div>
        </div>
    );
};

const WelcomeScreen = ({ onStart }) => {
    const [name, setName] = useState('');
    const [isInfoModalOpen, setIsInfoModalOpen] = useState(false);
    const InfoModal = ({onClose}) => (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}><div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full" onClick={e => e.stopPropagation()}><h2 className="text-2xl font-bold text-emerald-900 mb-4 text-center">Info Modul</h2><p className="text-gray-700 text-center">E-Modul Interaktif ini dirancang untuk memberikan pengalaman belajar yang menarik tentang sejarah Islamisasi di Sumatra. Jelajahi bab-bab, kumpulkan XP, dan jadilah seorang pakar sejarah!</p><button onClick={onClose} className="mt-8 w-full bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg transition-colors">Tutup</button></div></div>);
    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full">
                <h1 className="text-3xl font-extrabold text-emerald-900">Selamat Datang</h1>
                <p className="text-gray-600 mt-2">di E-Modul Interaktif Sejarah Islamisasi Sumatra</p>
                <p className="text-lg mt-6">Masukkan nama Anda untuk memulai petualangan:</p>
                <input type="text" value={name} onChange={e => setName(e.target.value)} className="mt-4 w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500" placeholder="Contoh: Ibnu Batutah" />
                <button onClick={() => onStart(name)} disabled={!name.trim()} className="mt-6 w-full bg-emerald-800 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition-colors disabled:bg-gray-400">Mulai Belajar</button>
                <button onClick={() => setIsInfoModalOpen(true)} className="mt-3 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 rounded-lg transition-colors">Info Modul</button>
            </div>
            {isInfoModalOpen && <InfoModal onClose={() => setIsInfoModalOpen(false)} />}
        </div>
    );
};

const ChapterCard = ({ chapter, onClick, isLocked, progress }) => {
    return (
        <div onClick={!isLocked ? onClick : undefined} className={`p-6 rounded-2xl shadow-lg transition-all duration-300 transform perspective-1000 ${isLocked ? 'bg-gray-200 text-gray-500' : 'bg-white hover:-translate-y-2 hover:shadow-2xl cursor-pointer'}`}>
            <div className="flex justify-between items-start">
                <div className="w-16 h-16 bg-emerald-100 text-emerald-800 text-3xl font-extrabold flex items-center justify-center rounded-xl">{chapter.id}</div>
                {isLocked && ( <div className="flex items-center gap-1 bg-gray-300 text-gray-700 text-xs font-bold px-2 py-1 rounded-full"><svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd"></path></svg><span>{chapter.requiredXp} XP</span></div> )}
                {progress === 'completed' && !isLocked && ( <div className="flex items-center gap-1 bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded-full"><svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"></path></svg><span>Selesai</span></div> )}
            </div>
            <h3 className="text-xl font-bold mt-4" style={{fontSize: '1.15rem'}}>{chapter.title}</h3>
            <p className="text-sm mt-2">{chapter.summary}</p>
        </div>
    );
};

const ProgressBar = ({ value, max, label }) => {
    const percentage = max > 0 ? (value / max) * 100 : 0;
    return (
        <div className="w-full">
            <div className="flex justify-between items-center mb-1"><span className="text-xs font-semibold text-emerald-200">{label}</span><span className="text-xs font-semibold text-white">{value} / {max} XP</span></div>
            <div className="w-full bg-emerald-700 rounded-full h-2.5"><div className="bg-white h-2.5 rounded-full" style={{ width: `${percentage}%` }}></div></div>
        </div>
    );
};

const Header = () => {
    const { gameState } = useGameState();
    const { playerName, xp, level, badges } = gameState;
    const currentLevelName = LEVELS[Math.min(level - 1, LEVELS.length - 1)];
    const xpInCurrentLevel = xp - (level - 1) * XP_PER_LEVEL;
    return (
        <header className="sticky top-0 z-50 bg-emerald-800 text-white shadow-lg p-3 sm:p-4">
            <div className="container mx-auto flex justify-between items-center gap-4">
                <div className="flex-1 min-w-0"><h1 className="text-lg sm:text-xl font-bold truncate">{playerName}</h1><p className="text-sm text-emerald-200">Level {level}: {currentLevelName}</p></div>
                <div className="w-1/3 max-w-xs"><ProgressBar value={xpInCurrentLevel} max={XP_PER_LEVEL} label={`Level ${level+1}`} /></div>
                <div className="flex items-center gap-2 sm:gap-4"><div className="flex items-center gap-1"><span className="text-yellow-300 text-lg">ðŸ†</span><span className="font-bold text-sm sm:text-base">{badges.length}</span></div></div>
            </div>
        </header>
    );
};

// --- Komponen Aplikasi Utama ---
const App = () => {
    const { gameState, setPlayerName } = useGameState();
    const [currentChapterId, setCurrentChapterId] = useState(null);
    const [isChatbotOpen, setIsChatbotOpen] = useState(false);
    const chatbotTriggerRef = useRef(null);
    const [showWelcome, setShowWelcome] = useState(gameState.playerName === 'Penjelajah');
    const handleStart = (name) => { setPlayerName(name || 'Penjelajah'); setShowWelcome(false); };
    if (showWelcome) return <WelcomeScreen onStart={handleStart} />;
    const currentChapter = CHAPTERS.find(c => c.id === currentChapterId);
    return (
        <div className="bg-gray-100 min-h-screen">
            <Header />
            <main className="py-8">
                {currentChapter ? <ChapterView chapter={currentChapter} onClose={() => setCurrentChapterId(null)} /> : (
                    <div className="container mx-auto px-4">
                        <div className="text-center mb-10"><h2 className="text-2xl font-bold tracking-tight text-gray-900 sm:text-3xl" style={{fontSize: '1.7rem'}}>Islamisasi di Sumatra</h2><p className="mt-3 max-w-2xl mx-auto text-base text-gray-500 sm:text-lg">Jelajahi jejak sejarah Islam di Pulau Emas.</p></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {CHAPTERS.map(chapter => { const isLocked = gameState.xp < chapter.requiredXp; const isCompleted = gameState.completedChapters.includes(chapter.id); const progress = isCompleted ? 'completed' : 'unlocked'; return <ChapterCard key={chapter.id} chapter={chapter} onClick={() => setCurrentChapterId(chapter.id)} isLocked={isLocked} progress={progress} />; })}
                        </div>
                    </div>
                )}
            </main>
            <div ref={chatbotTriggerRef} style={{ position: 'fixed', bottom: '20px', right: '20px', zIndex: 90 }}>
                <button onClick={() => setIsChatbotOpen(true)} className="w-16 h-16 bg-emerald-800 text-white rounded-full shadow-2xl flex items-center justify-center transform hover:scale-110 transition-transform" aria-label="Buka Pustakawan Kuno">
                     <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                </button>
            </div>
            <FluidPopup isOpen={isChatbotOpen} onClose={() => setIsChatbotOpen(false)} triggerRef={chatbotTriggerRef}>
                <Chatbot currentChapterId={currentChapterId} onClose={() => setIsChatbotOpen(false)} />
            </FluidPopup>
        </div>
    );
};

// --- RENDER APLIKASI ---
ReactDOM.render(
    <GameStateProvider>
        <App />
    </GameStateProvider>,
    document.getElementById('root')
);

    </script>
</body>
</html>